/* GDB target debugging macros

   Copyright (C) 2014-2024 Free Software Foundation, Inc.

   This file is part of GDB.

   This program is free software; you can redistribute it and/or modify
   it under the terms of the GNU General Public License as published by
   the Free Software Foundation; either version 3 of the License, or
   (at your option) any later version.

   This program is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU General Public License for more details.

   You should have received a copy of the GNU General Public License
   along with this program.  If not, see <http://www.gnu.org/licenses/>.  */

#ifndef TARGET_DEBUG_H
#define TARGET_DEBUG_H

/* Printers for the debug target.  Each prints an object of a given
   type to a string that needn't be freed.  Most printers are macros,
   for brevity, but a few are static functions where more complicated
   behavior is needed.

   References to these printers are automatically generated by
   make-target-delegates.  See the generated file target-delegates.c.

   In a couple cases, a special printing function is defined and then
   used via the TARGET_DEBUG_PRINTER macro.  See target.h.

   A few methods still have some explicit targetdebug code in
   target.c.  In most cases this is because target delegation hasn't
   been done for the method; but individual cases vary.  For instance,
   target_store_registers does some special register printing that is
   more simply done there, and target_xfer_partial additionally
   bypasses the debug target.  */

#include "gdbarch.h"
#include "gdbsupport/x86-xstate.h"
#include "progspace.h"
#include "target.h"
#include "target/wait.h"
#include "target/waitstatus.h"

/* The functions defined in this header file are not marked "inline", such
   that any function not used by target-delegates.c (the only user of this file)
   will be flagged as unused.  */

static void
target_debug_do_print (const char *s)
{ gdb_puts (s, gdb_stdlog); }

static void
target_debug_print_target_object (target_object object)
{ target_debug_do_print (plongest (object)); }

static void
target_debug_print_CORE_ADDR (CORE_ADDR addr)
{ target_debug_do_print (core_addr_to_string (addr)); }

static void
target_debug_print_const_char_p (const char *s)
{ target_debug_do_print (s != nullptr ? s : "(null)"); }

static void
target_debug_print_int (int v)
{ target_debug_do_print (plongest (v)); }

static void
target_debug_print_bool (bool v)
{ target_debug_do_print (v ? "true" : "false"); }

static void
target_debug_print_long (long v)
{ target_debug_do_print (plongest (v)); }

static void
target_debug_print_target_xfer_status (target_xfer_status status)
{ target_debug_do_print (plongest (status)); }

static void
target_debug_print_exec_direction_kind (exec_direction_kind kind)
{ target_debug_do_print (plongest (kind)); }

static void
target_debug_print_trace_find_type (trace_find_type type)
{ target_debug_do_print (plongest (type)); }

static void
target_debug_print_btrace_read_type (btrace_read_type type)
{ target_debug_do_print (plongest (type)); }

static void
target_debug_print_btrace_error (btrace_error error)
{ target_debug_do_print (plongest (error)); }

static void
target_debug_print_ptid_t (ptid_t ptid)
{ target_debug_do_print (plongest (ptid.pid ())); }

static void
target_debug_print_gdbarch_p (gdbarch *arch)
{ target_debug_do_print (gdbarch_bfd_arch_info (arch)->printable_name); }

static void
target_debug_print_const_gdb_byte_p (const gdb_byte *p)
{ target_debug_do_print (host_address_to_string (p)); }

static void
target_debug_print_gdb_byte_p (gdb_byte *p)
{ target_debug_do_print (host_address_to_string (p)); }

static void
target_debug_print_const_gdb_byte_pp (const gdb_byte **p)
{ target_debug_do_print (host_address_to_string (*p)); }

static void
target_debug_print_gdb_signal (gdb_signal sig)
{ target_debug_do_print (gdb_signal_to_name (sig)); }

static void
target_debug_print_ULONGEST (ULONGEST v)
{ target_debug_do_print (hex_string (v)); }

static void
target_debug_print_ULONGEST_p (ULONGEST *p)
{ target_debug_do_print (hex_string (*p)); }

static void
target_debug_print_LONGEST (LONGEST v)
{ target_debug_do_print (phex (v, 0)); }

static void
target_debug_print_LONGEST_p (LONGEST *p)
{ target_debug_do_print (phex (*p, 0)); }

static void
target_debug_print_bp_target_info_p (bp_target_info *bp)
{ target_debug_do_print (core_addr_to_string (bp->placed_address)); }

static void
target_debug_print_expression_p (expression *exp)
{ target_debug_do_print (host_address_to_string (exp)); }

static void
target_debug_print_CORE_ADDR_p (CORE_ADDR *p)
{ target_debug_do_print (core_addr_to_string (*p)); }

static void
target_debug_print_int_p (int *p)
{ target_debug_do_print (plongest (*p)); }

static void
target_debug_print_regcache_p (regcache *regcache)
{ target_debug_do_print (host_address_to_string (regcache)); }

static void
target_debug_print_thread_info_p (thread_info *thread)
{ target_debug_do_print (host_address_to_string (thread)); }

static void
target_debug_print_ui_file_p (ui_file *file)
{ target_debug_do_print (host_address_to_string (file)); }

static void
target_debug_print_const_std_vector_target_section_p
  (const std::vector<target_section> *vec)
{ target_debug_do_print (host_address_to_string (vec->data ())); }

static void
target_debug_print_void_p (void *p)
{ target_debug_do_print (host_address_to_string (p)); }

static void
target_debug_print_find_memory_region_ftype (find_memory_region_ftype func)
{ target_debug_do_print (host_address_to_string (func)); }

static void
target_debug_print_bfd_p (bfd *bfd)
{ target_debug_do_print (host_address_to_string (bfd)); }

static void
target_debug_print_std_vector_mem_region (const std::vector<mem_region> &vec)
{ target_debug_do_print (host_address_to_string (vec.data ())); }

static void
target_debug_print_std_vector_static_tracepoint_marker
  (const std::vector<static_tracepoint_marker> &vec)
{ target_debug_do_print (host_address_to_string (vec.data ())); }

static void
target_debug_print_const_target_desc_p (const target_desc *tdesc)
{ target_debug_do_print (host_address_to_string (tdesc)); }

static void
target_debug_print_bp_location_p (bp_location *loc)
{ target_debug_do_print (host_address_to_string (loc)); }

static void
target_debug_print_const_trace_state_variable_r
  (const trace_state_variable &tsv)
{ target_debug_do_print (host_address_to_string (&tsv)); }

static void
target_debug_print_trace_status_p (trace_status *status)
{ target_debug_do_print (host_address_to_string (status)); }

static void
target_debug_print_tracepoint_p (tracepoint *tp)
{ target_debug_do_print (host_address_to_string (tp)); }

static void
target_debug_print_uploaded_tp_p (uploaded_tp *tp)
{ target_debug_do_print (host_address_to_string (tp)); }

static void
target_debug_print_uploaded_tp_pp (uploaded_tp **v)
{ target_debug_do_print (host_address_to_string (*v)); }

static void
target_debug_print_uploaded_tsv_pp (uploaded_tsv **tsv)
{ target_debug_do_print (host_address_to_string (tsv)); }

static void
target_debug_print_static_tracepoint_marker_p (static_tracepoint_marker *marker)
{ target_debug_do_print (host_address_to_string (marker)); }

static void
target_debug_print_btrace_target_info_p (btrace_target_info *info)
{ target_debug_do_print (host_address_to_string (info)); }

static void
target_debug_print_const_frame_unwind_p (const frame_unwind *fu)
{ target_debug_do_print (host_address_to_string (fu)); }

static void
target_debug_print_btrace_data_p (btrace_data *data)
{ target_debug_do_print (host_address_to_string (data)); }

static void
target_debug_print_record_method (record_method method)
{ target_debug_do_print (plongest (method)); }

static void
target_debug_print_const_btrace_config_p (const btrace_config *config)
{ target_debug_do_print (host_address_to_string (config)); }

static void
target_debug_print_const_btrace_target_info_p (const btrace_target_info *info)
{ target_debug_do_print (host_address_to_string (info)); }

static void
target_debug_print_target_hw_bp_type (target_hw_bp_type type)
{ target_debug_do_print (plongest (type)); }

static void
target_debug_print_bptype (bptype type)
{ target_debug_do_print (plongest (type)); }

static void
target_debug_print_inferior_p (inferior *inf)
{ target_debug_do_print (host_address_to_string (inf)); }

static void
target_debug_print_remove_bp_reason (remove_bp_reason reason)
{ target_debug_do_print (plongest (reason)); }

static void
target_debug_print_gdb_disassembly_flags (gdb_disassembly_flags flags)
{ target_debug_do_print (plongest (flags)); }

static void
target_debug_print_traceframe_info_up (std::unique_ptr<traceframe_info> &info)
{ target_debug_do_print (host_address_to_string (info.get ())); }

static void
target_debug_print_gdb_array_view_const_int
  (const gdb::array_view<const int> &view)
{ target_debug_do_print (host_address_to_string (view.data ())); }

static void
target_debug_print_record_print_flags (record_print_flags flags)
{ target_debug_do_print (plongest (flags)); }

static void
target_debug_print_thread_control_capabilities (thread_control_capabilities cap)
{ target_debug_do_print (plongest (cap)); }

static void
target_debug_print_std_string (const std::string &str)
{ target_debug_do_print (str.c_str ()); }

static void
target_debug_print_gdb_unique_xmalloc_ptr_char
  (const gdb::unique_xmalloc_ptr<char> &p)
{ target_debug_do_print (p.get ()); }

static void
target_debug_print_target_waitkind (target_waitkind kind)
{ target_debug_do_print (pulongest (kind)); }

static void
target_debug_print_gdb_thread_options (gdb_thread_options options)
{ target_debug_do_print (to_string (options).c_str ()); }

static void
target_debug_print_target_waitstatus_p (struct target_waitstatus *status)
{
  gdb_puts (status->to_string ().c_str (), gdb_stdlog);
}

/* Functions that are used via TARGET_DEBUG_PRINTER.  */

static void
target_debug_print_step (int step)
{ target_debug_do_print (step ? "step" : "continue"); }

static void
target_debug_print_target_wait_flags (target_wait_flags options)
{
  std::string str = target_options_to_string (options);

  gdb_puts (str.c_str (), gdb_stdlog);
}

static void
target_debug_print_signals (gdb::array_view<const unsigned char> sigs)
{
  gdb_puts ("{", gdb_stdlog);

  for (size_t i = 0; i < sigs.size (); i++)
    if (sigs[i] != 0)
      {
	gdb_printf (gdb_stdlog, " %s",
		    gdb_signal_to_name ((enum gdb_signal) i));
      }
  gdb_puts (" }", gdb_stdlog);
}

static void
target_debug_print_size_t (size_t size)
{
  gdb_printf (gdb_stdlog, "%s", pulongest (size));
}

static void
target_debug_print_gdb_array_view_const_gdb_byte (gdb::array_view<const gdb_byte> vector)
{
  gdb_puts ("{", gdb_stdlog);

  for (size_t i = 0; i < vector.size (); i++)
    {
      gdb_printf (gdb_stdlog, " %s",
		  phex_nz (vector[i], 1));
    }
  gdb_puts (" }", gdb_stdlog);
}

static void
target_debug_print_const_gdb_byte_vector_r (const gdb::byte_vector &vector)
{
  target_debug_print_gdb_array_view_const_gdb_byte (vector);
}

static void
target_debug_print_gdb_byte_vector_r (gdb::byte_vector &vector)
{
  target_debug_print_const_gdb_byte_vector_r (vector);
}

static void
target_debug_print_x86_xsave_layout (const x86_xsave_layout &layout)
{
  gdb_puts ("{", gdb_stdlog);
  gdb_printf (gdb_stdlog, " sizeof_xsave=%d", layout.sizeof_xsave);
#define POFFS(region)							\
  if (layout.region##_offset != 0)					\
    gdb_printf (gdb_stdlog, ", %s_offset=%d", #region,			\
		layout.region##_offset)
  POFFS(avx);
  POFFS(bndregs);
  POFFS(bndcfg);
  POFFS(k);
  POFFS(zmm_h);
  POFFS(zmm);
  POFFS(pkru);
#undef POFFS
  gdb_puts (" }", gdb_stdlog);
}
#endif /* TARGET_DEBUG_H */
